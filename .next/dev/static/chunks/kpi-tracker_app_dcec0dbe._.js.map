{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/coenie/kpi-tracker/app/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey, {\r\n  auth: {\r\n    persistSession: true,\r\n    autoRefreshToken: true,\r\n    detectSessionInUrl: true,\r\n  },\r\n});\r\n\r\n// Types\r\nexport interface Profile {\r\n  id: string;\r\n  email: string;\r\n  full_name: string;\r\n  role: string;\r\n  avatar?: string;\r\n  avatar_url?: string;\r\n  definition?: string;\r\n  responsibilities?: string[];\r\n  is_admin: boolean;\r\n  is_active: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n  kpi_config?: {\r\n    kpis: {\r\n      name: string;\r\n      target: number;\r\n      current: number;\r\n      unit: string;\r\n      category: string;\r\n    }[];\r\n  };\r\n}\r\n\r\nexport interface Ticket {\r\n  id: string;\r\n  ticket_number: string;\r\n  user_id: string;\r\n  client: string;\r\n  clickup_ticket?: string;\r\n  location: 'on-site' | 'remote';\r\n  status: 'open' | 'closed';\r\n  issue: string;\r\n  resolution?: string;\r\n  response_time_minutes?: number;\r\n  created_at: string;\r\n  closed_at?: string;\r\n  created_by?: string;\r\n  has_dependencies?: boolean;\r\n  dependency_name?: string;\r\n  ticket_type?: 'Hardware' | 'Software' | 'New Site';\r\n  estate_or_building?: string;\r\n  cml_location?: string;\r\n  // New Site fields\r\n  site_name?: string;\r\n  installers?: string[];\r\n  site_files?: { url: string; name: string; type: string; label?: string }[];\r\n  dependencies?: string[];\r\n  target_date?: string;\r\n  // Attachments for regular tickets\r\n  attachments?: { url: string; name: string; type: string }[];\r\n  updates?: { text: string; timestamp: string }[];\r\n  time_logs?: { minutes: number; description: string; timestamp: string; logged_by?: string }[];\r\n  total_time_minutes?: number;\r\n  // Joined data\r\n  profile?: Profile;\r\n}\r\n\r\n// Auth helpers\r\nexport async function signIn(email: string, password: string) {\r\n  const { data, error } = await supabase.auth.signInWithPassword({\r\n    email,\r\n    password,\r\n  });\r\n  return { data, error };\r\n}\r\n\r\n// SECURITY: Public sign-ups are disabled - only admins can create accounts\r\n// This function is kept for admin use only (not exposed in UI)\r\nexport async function signUp(email: string, password: string, fullName: string, role: string) {\r\n  // Additional security: This should only be called from admin context\r\n  // In production, consider adding server-side API route protection\r\n  const { data, error } = await supabase.auth.signUp({\r\n    email,\r\n    password,\r\n    options: {\r\n      data: {\r\n        full_name: fullName,\r\n        role: role,\r\n      },\r\n    },\r\n  });\r\n  return { data, error };\r\n}\r\n\r\nexport async function signOut() {\r\n  const { error } = await supabase.auth.signOut();\r\n  return { error };\r\n}\r\n\r\nexport async function resetPassword(email: string) {\r\n  const { data, error } = await supabase.auth.resetPasswordForEmail(email, {\r\n    redirectTo: `${window.location.origin}/reset-password`,\r\n  });\r\n  return { data, error };\r\n}\r\n\r\nexport async function updatePassword(newPassword: string) {\r\n  const { data, error } = await supabase.auth.updateUser({\r\n    password: newPassword\r\n  });\r\n  return { data, error };\r\n}\r\n\r\nexport async function getCurrentUser() {\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  return user;\r\n}\r\n\r\nexport async function getCurrentProfile(userId?: string): Promise<Profile | null> {\r\n  try {\r\n    let uid = userId;\r\n    \r\n    if (!uid) {\r\n      const user = await getCurrentUser();\r\n      if (!user) {\r\n        console.log('getCurrentProfile: No user found');\r\n        return null;\r\n      }\r\n      uid = user.id;\r\n    }\r\n\r\n    console.log('getCurrentProfile: Fetching profile for user', uid);\r\n\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('id', uid)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('getCurrentProfile: Error:', error.message);\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  } catch (err) {\r\n    console.error('getCurrentProfile: Exception:', err);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Profile helpers\r\nexport async function getAllProfiles(): Promise<Profile[]> {\r\n  const { data, error } = await supabase\r\n    .from('profiles')\r\n    .select('*')\r\n    .order('full_name');\r\n  \r\n  if (error) {\r\n    console.error('Error fetching profiles:', error);\r\n    return [];\r\n  }\r\n  \r\n  return data || [];\r\n}\r\n\r\nexport async function getProfileById(id: string): Promise<Profile | null> {\r\n  const { data, error } = await supabase\r\n    .from('profiles')\r\n    .select('*')\r\n    .eq('id', id)\r\n    .single();\r\n  \r\n  if (error) {\r\n    console.error('Error fetching profile:', error);\r\n    return null;\r\n  }\r\n  \r\n  return data;\r\n}\r\n\r\nexport async function updateProfile(id: string, updates: Partial<Profile>) {\r\n  const { data, error } = await supabase\r\n    .from('profiles')\r\n    .update({ ...updates, updated_at: new Date().toISOString() })\r\n    .eq('id', id)\r\n    .select()\r\n    .single();\r\n  \r\n  return { data, error };\r\n}\r\n\r\nexport async function uploadProfilePicture(userId: string, file: File): Promise<{ publicUrl: string | null; error: Error | null }> {\r\n  const fileExt = file.name.split('.').pop();\r\n  // Use consistent filename to allow overwriting\r\n  const fileName = `${userId}.${fileExt}`;\r\n  const filePath = `avatars/${fileName}`;\r\n\r\n  // First, try to delete the old file if it exists\r\n  const { data: existingFiles } = await supabase.storage\r\n    .from('profiles')\r\n    .list('avatars', {\r\n      search: userId\r\n    });\r\n\r\n  if (existingFiles && existingFiles.length > 0) {\r\n    // Delete old avatar files for this user\r\n    const filesToDelete = existingFiles\r\n      .filter(f => f.name.startsWith(userId))\r\n      .map(f => `avatars/${f.name}`);\r\n    \r\n    if (filesToDelete.length > 0) {\r\n      await supabase.storage\r\n        .from('profiles')\r\n        .remove(filesToDelete);\r\n    }\r\n  }\r\n\r\n  // Upload the new file (upsert allows overwriting)\r\n  const { error: uploadError } = await supabase.storage\r\n    .from('profiles')\r\n    .upload(filePath, file, {\r\n      cacheControl: '3600',\r\n      upsert: true,\r\n    });\r\n\r\n  if (uploadError) {\r\n    console.error('Error uploading file:', uploadError);\r\n    return { publicUrl: null, error: uploadError };\r\n  }\r\n\r\n  const { data: publicUrlData } = supabase.storage\r\n    .from('profiles')\r\n    .getPublicUrl(filePath);\r\n\r\n  if (!publicUrlData || !publicUrlData.publicUrl) {\r\n    return { publicUrl: null, error: new Error('Could not get public URL for uploaded file.') };\r\n  }\r\n\r\n  // Update profile with new avatar_url\r\n  const { error: updateError } = await supabase\r\n    .from('profiles')\r\n    .update({ avatar_url: publicUrlData.publicUrl })\r\n    .eq('id', userId);\r\n\r\n  if (updateError) {\r\n    console.error('Error updating profile with avatar URL:', updateError);\r\n    return { publicUrl: null, error: updateError };\r\n  }\r\n\r\n  return { publicUrl: publicUrlData.publicUrl, error: null };\r\n}\r\n\r\n// Upload ticket attachments (images/files)\r\nexport async function uploadTicketAttachment(\r\n  ticketId: string,\r\n  file: File,\r\n  fileType: 'attachment' | 'site_file',\r\n  label?: string\r\n): Promise<{ url: string | null; error: Error | null }> {\r\n  const fileExt = file.name.split('.').pop();\r\n  const timestamp = Date.now();\r\n  const fileName = `${ticketId}-${timestamp}.${fileExt}`;\r\n  const folder = fileType === 'site_file' ? 'site-files' : 'attachments';\r\n  const filePath = `${folder}/${fileName}`;\r\n\r\n  // Upload the file\r\n  const { error: uploadError } = await supabase.storage\r\n    .from('tickets')\r\n    .upload(filePath, file, {\r\n      cacheControl: '3600',\r\n      upsert: false,\r\n    });\r\n\r\n  if (uploadError) {\r\n    console.error('Error uploading ticket file:', uploadError);\r\n    return { url: null, error: uploadError };\r\n  }\r\n\r\n  const { data: publicUrlData } = supabase.storage\r\n    .from('tickets')\r\n    .getPublicUrl(filePath);\r\n\r\n  if (!publicUrlData || !publicUrlData.publicUrl) {\r\n    return { url: null, error: new Error('Could not get public URL for uploaded file.') };\r\n  }\r\n\r\n  return {\r\n    url: publicUrlData.publicUrl,\r\n    error: null\r\n  };\r\n}\r\n\r\n// Ticket helpers\r\nexport async function getAllTickets(): Promise<Ticket[]> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from('tickets')\r\n      .select('*, profile:profiles!user_id(*)')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    if (error) {\r\n      // Log error details in a way that's visible in the console\r\n      const errorInfo = `Error fetching tickets: ${error.message || 'Unknown error'} (Code: ${error.code || 'NO_CODE'})`;\r\n      console.error(errorInfo);\r\n      \r\n      // Log structured error for debugging\r\n      console.error('Error details:', {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n        hint: error.hint,\r\n      });\r\n      \r\n      // Also log to help debug RLS issues\r\n      if (error.code === 'PGRST116' || error.message?.includes('permission') || error.message?.includes('policy')) {\r\n        console.error('⚠️ This might be an RLS (Row Level Security) policy issue. Check your Supabase RLS policies.');\r\n        console.error('Make sure your user profile has is_admin = TRUE in the profiles table.');\r\n      }\r\n      \r\n      return [];\r\n    }\r\n    \r\n    // Ensure time_logs is always an array for existing tickets\r\n    const normalizedData = (data || []).map(ticket => ({\r\n      ...ticket,\r\n      time_logs: Array.isArray(ticket.time_logs) ? ticket.time_logs : [],\r\n      updates: Array.isArray(ticket.updates) ? ticket.updates : [],\r\n      total_time_minutes: ticket.total_time_minutes || 0\r\n    }));\r\n    \r\n    return normalizedData;\r\n  } catch (err: any) {\r\n    console.error('Exception in getAllTickets:', err);\r\n    console.error('Exception details:', err?.message, err?.stack);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function getTicketsByUserId(userId: string): Promise<Ticket[]> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from('tickets')\r\n      .select('*')\r\n      .eq('user_id', userId)\r\n      .order('created_at', { ascending: false });\r\n    \r\n    if (error) {\r\n      console.error('Error fetching user tickets:', {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n        hint: error.hint,\r\n        fullError: error\r\n      });\r\n      return [];\r\n    }\r\n    \r\n    // Ensure time_logs is always an array for existing tickets\r\n    const normalizedData = (data || []).map(ticket => ({\r\n      ...ticket,\r\n      time_logs: Array.isArray(ticket.time_logs) ? ticket.time_logs : [],\r\n      updates: Array.isArray(ticket.updates) ? ticket.updates : [],\r\n      total_time_minutes: ticket.total_time_minutes || 0\r\n    }));\r\n    \r\n    return normalizedData;\r\n  } catch (err) {\r\n    console.error('Exception in getTicketsByUserId:', err);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function createTicket(ticket: {\r\n  user_id: string;\r\n  client: string;\r\n  clickup_ticket?: string;\r\n  location: 'on-site' | 'remote';\r\n  issue: string;\r\n  created_by?: string;\r\n  has_dependencies?: boolean;\r\n  dependency_name?: string;\r\n  ticket_type?: 'Hardware' | 'Software' | 'New Site';\r\n  estate_or_building?: string;\r\n  cml_location?: string;\r\n  // New Site fields\r\n  site_name?: string;\r\n  installers?: string[];\r\n  site_files?: { url: string; name: string; type: string; label?: string }[];\r\n  dependencies?: string[];\r\n  target_date?: string;\r\n  // Attachments for regular tickets\r\n  attachments?: { url: string; name: string; type: string }[];\r\n}): Promise<{ data: Ticket | null; error: Error | null }> {\r\n  // Generate ticket number\r\n  const today = new Date();\r\n  const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');\r\n  \r\n  // Get user's initials from profile\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('full_name')\r\n    .eq('id', ticket.user_id)\r\n    .single();\r\n  \r\n  const initials = profile?.full_name\r\n    ? profile.full_name.split(' ').map((n: string) => n[0]).join('').toUpperCase()\r\n    : 'XX';\r\n  \r\n  // Get count of tickets for this user today\r\n  const { count } = await supabase\r\n    .from('tickets')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('user_id', ticket.user_id)\r\n    .gte('created_at', today.toISOString().slice(0, 10));\r\n  \r\n  const seq = String((count || 0) + 1).padStart(3, '0');\r\n  const ticketNumber = `${initials}-${dateStr}-${seq}`;\r\n\r\n  const now = new Date();\r\n  \r\n  // Initialize with a time log entry for ticket creation\r\n  const initialTimeLog = {\r\n    minutes: 0, // Will be calculated on first update\r\n    description: 'Ticket opened',\r\n    timestamp: now.toISOString(),\r\n    logged_by: 'System'\r\n  };\r\n\r\n  const { data, error } = await supabase\r\n    .from('tickets')\r\n    .insert({\r\n      ...ticket,\r\n      ticket_number: ticketNumber,\r\n      status: 'open',\r\n      updates: [],\r\n      time_logs: [initialTimeLog],\r\n      total_time_minutes: 0,\r\n      installers: ticket.installers || [],\r\n      dependencies: ticket.dependencies || [],\r\n      site_files: ticket.site_files || [],\r\n      attachments: ticket.attachments || [],\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  return { data, error: error as Error | null };\r\n}\r\n\r\nexport async function updateTicket(ticketId: string, updates: Partial<Ticket>) {\r\n  const { data, error } = await supabase\r\n    .from('tickets')\r\n    .update(updates)\r\n    .eq('id', ticketId)\r\n    .select()\r\n    .single();\r\n\r\n  return { data, error };\r\n}\r\n\r\nexport async function closeTicket(ticketId: string, resolution: string) {\r\n  // Get the ticket to calculate response time\r\n  const { data: ticket, error: fetchError } = await supabase\r\n    .from('tickets')\r\n    .select('created_at')\r\n    .eq('id', ticketId)\r\n    .single();\r\n\r\n  if (fetchError || !ticket) {\r\n    console.error('Error fetching ticket:', fetchError);\r\n    return { data: null, error: fetchError };\r\n  }\r\n\r\n  // Calculate response time in minutes\r\n  const createdAt = new Date(ticket.created_at);\r\n  const closedAt = new Date();\r\n  const responseTimeMinutes = Math.round((closedAt.getTime() - createdAt.getTime()) / (1000 * 60));\r\n\r\n  const { data, error } = await supabase\r\n    .from('tickets')\r\n    .update({\r\n      status: 'closed',\r\n      resolution,\r\n      response_time_minutes: responseTimeMinutes,\r\n      closed_at: closedAt.toISOString(),\r\n    })\r\n    .eq('id', ticketId)\r\n    .select()\r\n    .single();\r\n\r\n  return { data, error };\r\n}\r\n\r\nexport async function deleteTicket(ticketId: string) {\r\n  const { error } = await supabase\r\n    .from('tickets')\r\n    .delete()\r\n    .eq('id', ticketId);\r\n\r\n  return { error };\r\n}\r\n\r\nexport async function addTicketUpdate(ticketId: string, updateText: string, loggedBy?: string) {\r\n  // Get the current ticket with all necessary fields\r\n  const { data: ticket, error: fetchError } = await supabase\r\n    .from('tickets')\r\n    .select('created_at, updates, time_logs, total_time_minutes')\r\n    .eq('id', ticketId)\r\n    .single();\r\n\r\n  if (fetchError) {\r\n    return { data: null, error: fetchError };\r\n  }\r\n\r\n  const now = new Date();\r\n  const newUpdate = {\r\n    text: updateText,\r\n    timestamp: now.toISOString()\r\n  };\r\n\r\n  // Append to existing updates or create new array\r\n  const existingUpdates = ticket?.updates || [];\r\n  const updatedUpdates = [...existingUpdates, newUpdate];\r\n\r\n  // Auto-calculate time since last update (or ticket creation if first update)\r\n  let timeMinutes = 0;\r\n  const createdAt = new Date(ticket.created_at);\r\n  \r\n  if (existingUpdates.length > 0) {\r\n    // Calculate time since last update\r\n    const lastUpdate = existingUpdates[existingUpdates.length - 1];\r\n    const lastUpdateTime = new Date(lastUpdate.timestamp);\r\n    timeMinutes = Math.round((now.getTime() - lastUpdateTime.getTime()) / (1000 * 60));\r\n  } else {\r\n    // First update - calculate time since ticket creation\r\n    timeMinutes = Math.round((now.getTime() - createdAt.getTime()) / (1000 * 60));\r\n  }\r\n\r\n  // Always log time (even if 0, to track continuous time)\r\n  const existingLogs = ticket?.time_logs || [];\r\n  let updatedLogs = existingLogs;\r\n  \r\n  // If this is the first update and we have the initial \"Ticket opened\" log, update it with the time\r\n  if (existingUpdates.length === 0 && existingLogs.length > 0 && existingLogs[0].description === 'Ticket opened' && existingLogs[0].minutes === 0) {\r\n    // Update the initial log with the actual time from creation to first update\r\n    updatedLogs = [\r\n      {\r\n        ...existingLogs[0],\r\n        minutes: timeMinutes,\r\n        description: `Time from ticket creation to first update`\r\n      }\r\n    ];\r\n  } else if (timeMinutes > 0) {\r\n    // Add new time log entry for this update\r\n    const newTimeLog = {\r\n      minutes: timeMinutes,\r\n      description: `Time tracked for update: \"${updateText.substring(0, 50)}${updateText.length > 50 ? '...' : ''}\"`,\r\n      timestamp: now.toISOString(),\r\n      logged_by: loggedBy || 'System'\r\n    };\r\n    updatedLogs = [...existingLogs, newTimeLog];\r\n  }\r\n  \r\n  // Calculate total time\r\n  const totalTime = updatedLogs.reduce((sum: number, log: { minutes: number }) => sum + log.minutes, 0);\r\n\r\n  // Update the ticket with both updates and time logs\r\n  const { data, error } = await supabase\r\n    .from('tickets')\r\n    .update({ \r\n      updates: updatedUpdates,\r\n      time_logs: updatedLogs.length > 0 ? updatedLogs : [],\r\n      total_time_minutes: totalTime\r\n    })\r\n    .eq('id', ticketId)\r\n    .select()\r\n    .single();\r\n  \r\n  if (error) {\r\n    console.error('Error updating ticket with time logs:', error.message || error.code || error);\r\n  }\r\n\r\n  return { data, error };\r\n}\r\n\r\nexport async function logTicketTime(ticketId: string, minutes: number, description: string, loggedBy?: string) {\r\n  // First get the current ticket to get existing time logs\r\n  const { data: ticket, error: fetchError } = await supabase\r\n    .from('tickets')\r\n    .select('time_logs, total_time_minutes')\r\n    .eq('id', ticketId)\r\n    .single();\r\n\r\n  if (fetchError) {\r\n    return { data: null, error: fetchError };\r\n  }\r\n\r\n  // Create new time log entry\r\n  const newTimeLog = {\r\n    minutes,\r\n    description,\r\n    timestamp: new Date().toISOString(),\r\n    logged_by: loggedBy\r\n  };\r\n\r\n  // Append to existing time logs or create new array\r\n  const existingLogs = ticket?.time_logs || [];\r\n  const updatedLogs = [...existingLogs, newTimeLog];\r\n\r\n  // Calculate total time\r\n  const totalTime = updatedLogs.reduce((sum: number, log: { minutes: number }) => sum + log.minutes, 0);\r\n\r\n  // Update the ticket\r\n  const { data, error } = await supabase\r\n    .from('tickets')\r\n    .update({ \r\n      time_logs: updatedLogs,\r\n      total_time_minutes: totalTime\r\n    })\r\n    .eq('id', ticketId)\r\n    .select()\r\n    .single();\r\n\r\n  return { data, error };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 505, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/coenie/kpi-tracker/app/context/AuthContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { createContext, useContext, useEffect, useState, ReactNode, useCallback } from 'react';\r\nimport { supabase, Profile, getCurrentProfile } from '../lib/supabase';\r\nimport { User, Session } from '@supabase/supabase-js';\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  profile: Profile | null;\r\n  session: Session | null;\r\n  loading: boolean;\r\n  isAdmin: boolean;\r\n  signIn: (email: string, password: string) => Promise<{ error: Error | null }>;\r\n  signUp: (email: string, password: string, fullName: string, role: string) => Promise<{ error: Error | null }>;\r\n  signOut: () => Promise<void>;\r\n  refreshProfile: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [profile, setProfile] = useState<Profile | null>(null);\r\n  const [session, setSession] = useState<Session | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const fetchProfile = useCallback(async (userId: string) => {\r\n    try {\r\n      const prof = await getCurrentProfile(userId);\r\n      setProfile(prof);\r\n      return prof;\r\n    } catch (err) {\r\n      console.error('Error fetching profile:', err);\r\n      return null;\r\n    }\r\n  }, []);\r\n\r\n  const refreshProfile = useCallback(async () => {\r\n    if (user?.id) {\r\n      await fetchProfile(user.id);\r\n    }\r\n  }, [user?.id, fetchProfile]);\r\n\r\n  useEffect(() => {\r\n    let isMounted = true;\r\n\r\n    const initialize = async () => {\r\n      try {\r\n        // Get the current session\r\n        const { data: { session: currentSession } } = await supabase.auth.getSession();\r\n        \r\n        if (!isMounted) return;\r\n\r\n        if (currentSession?.user) {\r\n          setSession(currentSession);\r\n          setUser(currentSession.user);\r\n          await fetchProfile(currentSession.user.id);\r\n        }\r\n      } catch (error) {\r\n        console.error('Auth initialization error:', error);\r\n      } finally {\r\n        if (isMounted) {\r\n          setLoading(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    // Set up auth state listener FIRST\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\r\n      async (event, newSession) => {\r\n        if (!isMounted) return;\r\n\r\n        console.log('Auth state change:', event);\r\n\r\n        setSession(newSession);\r\n        setUser(newSession?.user ?? null);\r\n\r\n        if (newSession?.user) {\r\n          // Use setTimeout to avoid race conditions with Supabase\r\n          setTimeout(() => {\r\n            if (isMounted) {\r\n              fetchProfile(newSession.user.id);\r\n            }\r\n          }, 100);\r\n        } else {\r\n          setProfile(null);\r\n        }\r\n\r\n        setLoading(false);\r\n      }\r\n    );\r\n\r\n    // Then initialize\r\n    initialize();\r\n\r\n    // Safety timeout\r\n    const timeout = setTimeout(() => {\r\n      if (isMounted && loading) {\r\n        console.log('Auth timeout - forcing load complete');\r\n        setLoading(false);\r\n      }\r\n    }, 3000);\r\n\r\n    return () => {\r\n      isMounted = false;\r\n      subscription.unsubscribe();\r\n      clearTimeout(timeout);\r\n    };\r\n  }, [fetchProfile, loading]);\r\n\r\n  const signIn = async (email: string, password: string) => {\r\n    const { error } = await supabase.auth.signInWithPassword({ email, password });\r\n    return { error: error as Error | null };\r\n  };\r\n\r\n  const signUp = async (email: string, password: string, fullName: string, role: string) => {\r\n    const avatar = fullName\r\n      .split(' ')\r\n      .map(part => part.charAt(0).toUpperCase())\r\n      .join('')\r\n      .slice(0, 2);\r\n\r\n    const { error } = await supabase.auth.signUp({\r\n      email,\r\n      password,\r\n      options: {\r\n        data: {\r\n          full_name: fullName,\r\n          role: role,\r\n          avatar: avatar\r\n        }\r\n      }\r\n    });\r\n    return { error: error as Error | null };\r\n  };\r\n\r\n  const signOut = async () => {\r\n    await supabase.auth.signOut();\r\n    setUser(null);\r\n    setProfile(null);\r\n    setSession(null);\r\n  };\r\n\r\n  const value = {\r\n    user,\r\n    profile,\r\n    session,\r\n    loading,\r\n    isAdmin: profile?.is_admin ?? false,\r\n    signIn,\r\n    signUp,\r\n    signOut,\r\n    refreshProfile\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={value}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}